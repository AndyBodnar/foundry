# Foundry MLOps Platform - Prometheus Configuration
# ==================================================
# This configuration scrapes metrics from all Foundry services
# and includes alerting rules for monitoring.

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: foundry-local
    env: development

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093
      timeout: 10s
      api_version: v2

# Rule files for alerts
rule_files:
  - /etc/prometheus/rules/*.yml

# Scrape configurations
scrape_configs:
  # =================================================
  # Prometheus self-monitoring
  # =================================================
  - job_name: prometheus
    static_configs:
      - targets:
          - localhost:9090
        labels:
          service: prometheus

  # =================================================
  # Foundry API Service
  # =================================================
  - job_name: foundry-api
    metrics_path: /metrics
    static_configs:
      - targets:
          - foundry-api:8080
        labels:
          service: api
          component: backend
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: (.+):.*
        replacement: $1

  # =================================================
  # Foundry Worker Service (Celery)
  # =================================================
  - job_name: foundry-worker
    metrics_path: /metrics
    static_configs:
      - targets:
          - foundry-worker:9090
        labels:
          service: worker
          component: backend
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: (.+):.*
        replacement: $1

  # =================================================
  # Foundry Inference Service
  # =================================================
  - job_name: foundry-inference
    metrics_path: /metrics
    static_configs:
      - targets:
          - foundry-inference:8081
        labels:
          service: inference
          component: ml
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: (.+):.*
        replacement: $1

  # =================================================
  # PostgreSQL Exporter
  # =================================================
  - job_name: postgres
    static_configs:
      - targets:
          - postgres-exporter:9187
        labels:
          service: postgres
          component: database

  # =================================================
  # Redis Exporter
  # =================================================
  - job_name: redis
    static_configs:
      - targets:
          - redis-exporter:9121
        labels:
          service: redis
          component: cache

  # =================================================
  # Kafka Exporter
  # =================================================
  - job_name: kafka
    static_configs:
      - targets:
          - kafka-exporter:9308
        labels:
          service: kafka
          component: messaging

  # =================================================
  # Node Exporter (Host Metrics)
  # =================================================
  - job_name: node
    static_configs:
      - targets:
          - node-exporter:9100
        labels:
          service: node
          component: infrastructure

  # =================================================
  # cAdvisor (Container Metrics)
  # =================================================
  - job_name: cadvisor
    static_configs:
      - targets:
          - cadvisor:8080
        labels:
          service: cadvisor
          component: infrastructure
    metric_relabel_configs:
      - source_labels: [container_name]
        regex: ^$
        action: drop
      - source_labels: [container_name]
        regex: POD
        action: drop

  # =================================================
  # Kubernetes Service Discovery (for K8s deployments)
  # =================================================
  # Uncomment when deploying to Kubernetes
  #
  # - job_name: kubernetes-pods
  #   kubernetes_sd_configs:
  #     - role: pod
  #   relabel_configs:
  #     - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
  #       action: keep
  #       regex: true
  #     - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
  #       action: replace
  #       target_label: __metrics_path__
  #       regex: (.+)
  #     - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
  #       action: replace
  #       regex: ([^:]+)(?::\d+)?;(\d+)
  #       replacement: $1:$2
  #       target_label: __address__
  #     - source_labels: [__meta_kubernetes_namespace]
  #       action: replace
  #       target_label: namespace
  #     - source_labels: [__meta_kubernetes_pod_name]
  #       action: replace
  #       target_label: pod
  #     - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
  #       action: replace
  #       target_label: app
  #
  # - job_name: kubernetes-services
  #   kubernetes_sd_configs:
  #     - role: service
  #   relabel_configs:
  #     - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
  #       action: keep
  #       regex: true
  #     - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
  #       action: replace
  #       target_label: __scheme__
  #       regex: (https?)
  #     - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
  #       action: replace
  #       target_label: __metrics_path__
  #       regex: (.+)
  #     - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
  #       action: replace
  #       target_label: __address__
  #       regex: ([^:]+)(?::\d+)?;(\d+)
  #       replacement: $1:$2
  #     - source_labels: [__meta_kubernetes_namespace]
  #       action: replace
  #       target_label: namespace
  #     - source_labels: [__meta_kubernetes_service_name]
  #       action: replace
  #       target_label: service
